---
import { Icon } from "astro-icon/components";
---

<div
  id="btt-btn-container"
  class:list={[
    "fixed end-4 bottom-8 z-50",
    "md:sticky md:end-auto md:float-end md:me-1",
    "translate-y-14 opacity-0 transition duration-500",
  ]}
>
  <button
    data-button="back-to-top"
    class:list={[
      "group relative bg-background px-2 py-1",
      "size-14 rounded-full shadow-xl",
      "md:h-8 md:w-fit md:rounded-md md:shadow-none md:focus-visible:rounded-none",
      "md:bg-background/35 md:bg-clip-padding md:backdrop-blur-lg",
    ]}
  >
    <Icon name="tabler:chevron-left" class="inline-block rotate-90 md:hidden" />
    <span class="sr-only text-sm group-hover:text-accent md:not-sr-only">
      <Icon name="tabler:arrow-narrow-up" class="inline-block size-4" />
      Back To Top
    </span>
  </button>
</div>

<script>
  /** Scrolls the document to the top when
   * the "Back to Top" button is clicked. */
  document.addEventListener("astro:page-load", () => {
    const btnContainer = document.querySelector("#btt-btn-container");
    if (btnContainer === null) return;

    const backToTopBtn = btnContainer.querySelector(
      "[data-button='back-to-top']"
    );
    backToTopBtn?.addEventListener("click", () => {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    });

    // Handle button visibility according to scroll position
    let lastVisible: boolean | undefined;
    function handleScroll() {
      if (btnContainer === null) return;
      const rootElement = document.documentElement;
      const scrollTotal = rootElement.scrollHeight - rootElement.clientHeight;
      const scrollTop = rootElement.scrollTop;
      const isVisible = scrollTop / scrollTotal > 0.1 || scrollTop > 1000;
      if (isVisible !== lastVisible) {
        btnContainer.classList.toggle("opacity-100", isVisible);
        btnContainer.classList.toggle("translate-y-0", isVisible);
        btnContainer.classList.toggle("opacity-0", !isVisible);
        btnContainer.classList.toggle("translate-y-14", !isVisible);
        lastVisible = isVisible;
      }
    }

    let ticking = false;
    const scrollListener = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    };
    document.addEventListener("scroll", scrollListener);
    document.addEventListener(
      "astro:before-swap",
      () => {
        document.removeEventListener("scroll", scrollListener);
      },
      { once: true }
    );
  });
</script>
