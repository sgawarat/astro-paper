---
import type { MarkdownHeading } from "astro";
import TocItem from "@/components/TocItem.astro";

const { headings } = Astro.props;

type TocNode = MarkdownHeading | TocNode[];

function buildTocTree(headings: MarkdownHeading[]) {
  let minDepth = Infinity;
  let maxDepth = 0;
  for (const h of headings) {
    minDepth = Math.min(minDepth, h.depth);
    maxDepth = Math.max(maxDepth, h.depth);
  }

  const baseDepth = minDepth - 1;
  const stack: TocNode[][] = [];
  for (const h of headings) {
    const depth = h.depth - baseDepth;
    if (stack.length > depth) {
      stack.length = depth;
    } else {
      while (stack.length < depth) {
        const items: TocNode[] = [];
        stack.at(-1)?.push(items);
        stack.push(items);
      }
    }
    stack.at(-1)?.push(h);
  }
  return stack[0];
}

const tree = buildTocTree(headings) ?? [];

export interface Props {
  headings: MarkdownHeading[];
}
---


{
  tree.length > 0 && (
    <nav class="py-4 pl-5 max-w-fit wrap-normal border-l">
      <TocItem items={tree} />
    </nav>
  )
}
